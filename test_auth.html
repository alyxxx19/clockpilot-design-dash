<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ClockPilot Auth Test</title>
    <style>
        body { 
            font-family: Arial, sans-serif; 
            max-width: 800px; 
            margin: 0 auto; 
            padding: 20px; 
            background: #f5f5f5;
        }
        .container { 
            background: white; 
            padding: 20px; 
            border-radius: 8px; 
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }
        .form-group { 
            margin-bottom: 15px; 
        }
        label { 
            display: block; 
            margin-bottom: 5px; 
            font-weight: bold;
        }
        input, select { 
            width: 100%; 
            padding: 8px 12px; 
            border: 1px solid #ddd; 
            border-radius: 4px; 
            box-sizing: border-box;
        }
        button { 
            background: #007bff; 
            color: white; 
            padding: 10px 20px; 
            border: none; 
            border-radius: 4px; 
            cursor: pointer; 
            margin-right: 10px;
        }
        button:hover { 
            background: #0056b3; 
        }
        .success { 
            background: #d4edda; 
            color: #155724; 
            padding: 10px; 
            border-radius: 4px; 
            margin: 10px 0;
        }
        .error { 
            background: #f8d7da; 
            color: #721c24; 
            padding: 10px; 
            border-radius: 4px; 
            margin: 10px 0;
        }
        .response { 
            background: #f8f9fa; 
            padding: 10px; 
            border-radius: 4px; 
            margin: 10px 0; 
            white-space: pre-wrap; 
            font-family: monospace;
            border-left: 4px solid #007bff;
        }
        h2 { 
            color: #333; 
            border-bottom: 2px solid #007bff; 
            padding-bottom: 10px;
        }
    </style>
</head>
<body>
    <h1>üïê ClockPilot Authentication Test</h1>
    
    <!-- Registration Form -->
    <div class="container">
        <h2>üìù Register User</h2>
        <form id="registerForm">
            <div class="form-group">
                <label for="regUsername">Username:</label>
                <input type="text" id="regUsername" required>
            </div>
            <div class="form-group">
                <label for="regEmail">Email:</label>
                <input type="email" id="regEmail" required>
            </div>
            <div class="form-group">
                <label for="regPassword">Password:</label>
                <input type="password" id="regPassword" required>
            </div>
            <div class="form-group">
                <label for="regFirstName">First Name:</label>
                <input type="text" id="regFirstName" required>
            </div>
            <div class="form-group">
                <label for="regLastName">Last Name:</label>
                <input type="text" id="regLastName" required>
            </div>
            <div class="form-group">
                <label for="regRole">Role:</label>
                <select id="regRole">
                    <option value="employee">Employee</option>
                    <option value="admin">Admin</option>
                </select>
            </div>
            <button type="submit">Register</button>
        </form>
        <div id="registerResponse"></div>
    </div>

    <!-- Login Form -->
    <div class="container">
        <h2>üîê Login User</h2>
        <form id="loginForm">
            <div class="form-group">
                <label for="loginEmail">Email:</label>
                <input type="email" id="loginEmail" required>
            </div>
            <div class="form-group">
                <label for="loginPassword">Password:</label>
                <input type="password" id="loginPassword" required>
            </div>
            <button type="submit">Login</button>
        </form>
        <div id="loginResponse"></div>
    </div>

    <!-- Protected Actions -->
    <div class="container">
        <h2>üîí Protected Actions</h2>
        <button onclick="getCurrentUser()">Get Current User (/api/auth/me)</button>
        <button onclick="getEmployees()">Get Employees (Admin Only)</button>
        <button onclick="getDepartments()">Get Departments</button>
        <button onclick="logout()">Logout</button>
        <div id="protectedResponse"></div>
    </div>

    <!-- Token Display -->
    <div class="container">
        <h2>üé´ Current Tokens</h2>
        <div id="tokenDisplay">No tokens set</div>
    </div>

    <script>
        let accessToken = localStorage.getItem('accessToken');
        let refreshToken = localStorage.getItem('refreshToken');
        
        function updateTokenDisplay() {
            const display = document.getElementById('tokenDisplay');
            if (accessToken) {
                display.innerHTML = `
                    <strong>Access Token:</strong> ${accessToken.substring(0, 50)}...<br>
                    <strong>Refresh Token:</strong> ${refreshToken ? refreshToken.substring(0, 50) + '...' : 'None'}
                `;
            } else {
                display.innerHTML = 'No tokens set';
            }
        }

        function showResponse(elementId, data, isError = false) {
            const element = document.getElementById(elementId);
            element.innerHTML = `
                <div class="${isError ? 'error' : 'success'}">
                    ${isError ? 'Error' : 'Success'}
                </div>
                <div class="response">${JSON.stringify(data, null, 2)}</div>
            `;
        }

        async function makeRequest(url, method = 'GET', body = null, useAuth = false) {
            const options = {
                method,
                headers: {
                    'Content-Type': 'application/json',
                },
            };

            if (useAuth && accessToken) {
                options.headers.Authorization = `Bearer ${accessToken}`;
            }

            if (body) {
                options.body = JSON.stringify(body);
            }

            try {
                const response = await fetch(url, options);
                const data = await response.json();
                
                if (!response.ok) {
                    throw { status: response.status, data };
                }
                
                return data;
            } catch (error) {
                throw error;
            }
        }

        // Register Form
        document.getElementById('registerForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const userData = {
                username: document.getElementById('regUsername').value,
                email: document.getElementById('regEmail').value,
                password: document.getElementById('regPassword').value,
                firstName: document.getElementById('regFirstName').value,
                lastName: document.getElementById('regLastName').value,
                role: document.getElementById('regRole').value,
            };

            try {
                const result = await makeRequest('/api/auth/register', 'POST', userData);
                showResponse('registerResponse', result);
                
                if (result.tokens) {
                    accessToken = result.tokens.accessToken;
                    refreshToken = result.tokens.refreshToken;
                    localStorage.setItem('accessToken', accessToken);
                    localStorage.setItem('refreshToken', refreshToken);
                    updateTokenDisplay();
                }
            } catch (error) {
                showResponse('registerResponse', error, true);
            }
        });

        // Login Form
        document.getElementById('loginForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const loginData = {
                email: document.getElementById('loginEmail').value,
                password: document.getElementById('loginPassword').value,
            };

            try {
                const result = await makeRequest('/api/auth/login', 'POST', loginData);
                showResponse('loginResponse', result);
                
                if (result.tokens) {
                    accessToken = result.tokens.accessToken;
                    refreshToken = result.tokens.refreshToken;
                    localStorage.setItem('accessToken', accessToken);
                    localStorage.setItem('refreshToken', refreshToken);
                    updateTokenDisplay();
                }
            } catch (error) {
                showResponse('loginResponse', error, true);
            }
        });

        // Protected Actions
        async function getCurrentUser() {
            try {
                const result = await makeRequest('/api/auth/me', 'GET', null, true);
                showResponse('protectedResponse', result);
            } catch (error) {
                showResponse('protectedResponse', error, true);
            }
        }

        async function getEmployees() {
            try {
                const result = await makeRequest('/api/employees', 'GET', null, true);
                showResponse('protectedResponse', result);
            } catch (error) {
                showResponse('protectedResponse', error, true);
            }
        }

        async function getDepartments() {
            try {
                const result = await makeRequest('/api/departments', 'GET', null, true);
                showResponse('protectedResponse', result);
            } catch (error) {
                showResponse('protectedResponse', error, true);
            }
        }

        async function logout() {
            try {
                const result = await makeRequest('/api/auth/logout', 'POST', null, true);
                showResponse('protectedResponse', result);
                
                // Clear tokens
                accessToken = null;
                refreshToken = null;
                localStorage.removeItem('accessToken');
                localStorage.removeItem('refreshToken');
                updateTokenDisplay();
            } catch (error) {
                showResponse('protectedResponse', error, true);
            }
        }

        // Initialize
        updateTokenDisplay();
        
        // Pre-fill forms for testing
        document.getElementById('regUsername').value = 'demo_user';
        document.getElementById('regEmail').value = 'demo@clockpilot.com';
        document.getElementById('regPassword').value = 'password123';
        document.getElementById('regFirstName').value = 'Demo';
        document.getElementById('regLastName').value = 'User';
        
        document.getElementById('loginEmail').value = 'demo@clockpilot.com';
        document.getElementById('loginPassword').value = 'password123';
    </script>
</body>
</html>