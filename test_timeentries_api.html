<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ClockPilot Time Entries API Test</title>
    <style>
        body { 
            font-family: Arial, sans-serif; 
            max-width: 1600px; 
            margin: 0 auto; 
            padding: 20px; 
            background: #f5f5f5;
        }
        .container { 
            background: white; 
            padding: 20px; 
            border-radius: 8px; 
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }
        .grid { 
            display: grid; 
            grid-template-columns: 1fr 1fr; 
            gap: 20px; 
        }
        .grid-3 { 
            display: grid; 
            grid-template-columns: 1fr 1fr 1fr; 
            gap: 15px; 
        }
        .form-group { 
            margin-bottom: 15px; 
        }
        label { 
            display: block; 
            margin-bottom: 5px; 
            font-weight: bold;
        }
        input, select, textarea { 
            width: 100%; 
            padding: 8px 12px; 
            border: 1px solid #ddd; 
            border-radius: 4px; 
            box-sizing: border-box;
        }
        button { 
            background: #007bff; 
            color: white; 
            padding: 10px 20px; 
            border: none; 
            border-radius: 4px; 
            cursor: pointer; 
            margin-right: 10px;
            margin-bottom: 10px;
        }
        button:hover { 
            background: #0056b3; 
        }
        button.success { 
            background: #28a745; 
        }
        button.success:hover { 
            background: #218838; 
        }
        button.warning { 
            background: #ffc107; 
            color: #212529;
        }
        button.warning:hover { 
            background: #e0a800; 
        }
        button.danger { 
            background: #dc3545; 
        }
        button.danger:hover { 
            background: #c82333; 
        }
        .success { 
            background: #d4edda; 
            color: #155724; 
            padding: 10px; 
            border-radius: 4px; 
            margin: 10px 0;
        }
        .error { 
            background: #f8d7da; 
            color: #721c24; 
            padding: 10px; 
            border-radius: 4px; 
            margin: 10px 0;
        }
        .warning { 
            background: #fff3cd; 
            color: #856404; 
            padding: 10px; 
            border-radius: 4px; 
            margin: 10px 0;
        }
        .response { 
            background: #f8f9fa; 
            padding: 10px; 
            border-radius: 4px; 
            margin: 10px 0; 
            white-space: pre-wrap; 
            font-family: monospace;
            border-left: 4px solid #007bff;
            max-height: 400px;
            overflow-y: auto;
        }
        h2 { 
            color: #333; 
            border-bottom: 2px solid #007bff; 
            padding-bottom: 10px;
        }
        h3 {
            color: #666;
            margin-top: 20px;
        }
        .time-entry {
            border: 1px solid #ddd;
            border-radius: 8px;
            padding: 15px;
            margin: 10px 0;
            background: #f9f9f9;
        }
        .time-entry h4 {
            margin: 0 0 10px 0;
            color: #333;
        }
        .flex {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }
        .status-badge {
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 12px;
            font-weight: bold;
        }
        .status-draft { background: #e9ecef; color: #495057; }
        .status-submitted { background: #cff4fc; color: #055160; }
        .status-validated { background: #d1e7dd; color: #0f5132; }
        .status-rejected { background: #f8d7da; color: #721c24; }
        .anomaly-item {
            border-left: 4px solid #ffc107;
            background: #fff3cd;
            padding: 10px;
            margin: 5px 0;
            border-radius: 4px;
        }
        .anomaly-error { border-left-color: #dc3545; background: #f8d7da; }
        .anomaly-warning { border-left-color: #ffc107; background: #fff3cd; }
        .anomaly-info { border-left-color: #0dcaf0; background: #cff4fc; }
        .hours-display {
            display: inline-block;
            padding: 4px 8px;
            background: #e7f3ff;
            border-radius: 4px;
            margin: 2px;
            font-weight: bold;
        }
        .overtime { background: #ffebee; color: #c62828; }
        .regular { background: #e8f5e8; color: #2e7d32; }
        .break-time { background: #fff3e0; color: #ef6c00; }
    </style>
</head>
<body>
    <h1>‚è∞ ClockPilot Time Entries API Test</h1>
    
    <!-- Auth Token -->
    <div class="container">
        <h2>üîë Authentication</h2>
        <div class="form-group">
            <label for="authToken">Access Token:</label>
            <input type="text" id="authToken" placeholder="Bearer token from login">
        </div>
        <button onclick="testAuthUser()">Test Token (Get Current User)</button>
        <div id="authResponse"></div>
    </div>

    <div class="grid">
        <!-- Get Time Entries -->
        <div class="container">
            <h2>üìã Get Time Entries</h2>
            <div class="form-group">
                <label for="timeEntryDateFrom">Date From:</label>
                <input type="date" id="timeEntryDateFrom">
            </div>
            <div class="form-group">
                <label for="timeEntryDateTo">Date To:</label>
                <input type="date" id="timeEntryDateTo">
            </div>
            <div class="form-group">
                <label for="timeEntryEmployeeId">Employee ID (optional):</label>
                <input type="number" id="timeEntryEmployeeId" placeholder="Leave empty for own entries">
            </div>
            <div class="form-group">
                <label for="timeEntryStatus">Status:</label>
                <select id="timeEntryStatus">
                    <option value="">All statuses</option>
                    <option value="draft">Draft</option>
                    <option value="submitted">Submitted</option>
                    <option value="validated">Validated</option>
                    <option value="rejected">Rejected</option>
                </select>
            </div>
            <div class="form-group">
                <label for="timeEntryGroupBy">Group By:</label>
                <select id="timeEntryGroupBy">
                    <option value="day">Day</option>
                    <option value="week">Week</option>
                    <option value="month">Month</option>
                </select>
            </div>
            <button onclick="getTimeEntries()">Get Time Entries</button>
            <div id="timeEntriesResponse"></div>
        </div>

        <!-- Current Day Time Entries -->
        <div class="container">
            <h2>üìÖ Current Day Time Entries</h2>
            <div class="form-group">
                <label for="currentEmployeeId">Employee ID:</label>
                <input type="number" id="currentEmployeeId" value="1" required>
            </div>
            <button onclick="getCurrentDayTimeEntries()">Get Current Day</button>
            <div id="currentDayResponse"></div>
        </div>
    </div>

    <!-- Create Time Entry -->
    <div class="container">
        <h2>‚ûï Create Time Entry</h2>
        <div class="grid-3">
            <div class="form-group">
                <label for="createDate">Date:</label>
                <input type="date" id="createDate" required>
            </div>
            <div class="form-group">
                <label for="createStartTime">Start Time:</label>
                <input type="time" id="createStartTime" required>
            </div>
            <div class="form-group">
                <label for="createEndTime">End Time:</label>
                <input type="time" id="createEndTime" required>
            </div>
        </div>
        <div class="grid-3">
            <div class="form-group">
                <label for="createBreakDuration">Break Duration (minutes):</label>
                <input type="number" id="createBreakDuration" min="0" max="240" value="60">
            </div>
            <div class="form-group">
                <label for="createProjectId">Project ID (optional):</label>
                <input type="number" id="createProjectId">
            </div>
            <div class="form-group">
                <label for="createTaskId">Task ID (optional):</label>
                <input type="number" id="createTaskId">
            </div>
        </div>
        <div class="grid">
            <div class="form-group">
                <label for="createDescription">Description:</label>
                <textarea id="createDescription" rows="3" placeholder="Work description..."></textarea>
            </div>
            <div>
                <div class="form-group">
                    <label for="createLocation">Location:</label>
                    <input type="text" id="createLocation" placeholder="Office, Remote, etc.">
                </div>
                <div class="form-group">
                    <label>
                        <input type="checkbox" id="createIsOvertime"> Is Overtime?
                    </label>
                </div>
                <div class="form-group">
                    <label for="createOvertimeReason">Overtime Reason:</label>
                    <input type="text" id="createOvertimeReason" placeholder="Reason for overtime">
                </div>
            </div>
        </div>
        <button class="success" onclick="createTimeEntry()">Create Time Entry</button>
        <div id="createResponse"></div>
    </div>

    <div class="grid">
        <!-- Update Time Entry -->
        <div class="container">
            <h2>‚úèÔ∏è Update Time Entry</h2>
            <div class="form-group">
                <label for="updateTimeEntryId">Time Entry ID:</label>
                <input type="number" id="updateTimeEntryId" required>
            </div>
            <div class="grid">
                <div>
                    <div class="form-group">
                        <label for="updateDate">Date:</label>
                        <input type="date" id="updateDate">
                    </div>
                    <div class="form-group">
                        <label for="updateStartTime">Start Time:</label>
                        <input type="time" id="updateStartTime">
                    </div>
                    <div class="form-group">
                        <label for="updateEndTime">End Time:</label>
                        <input type="time" id="updateEndTime">
                    </div>
                </div>
                <div>
                    <div class="form-group">
                        <label for="updateBreakDuration">Break Duration (minutes):</label>
                        <input type="number" id="updateBreakDuration" min="0" max="240">
                    </div>
                    <div class="form-group">
                        <label for="updateDescription">Description:</label>
                        <textarea id="updateDescription" rows="2"></textarea>
                    </div>
                    <div class="form-group">
                        <label>
                            <input type="checkbox" id="updateIsOvertime"> Is Overtime?
                        </label>
                    </div>
                </div>
            </div>
            <button onclick="updateTimeEntry()">Update Entry</button>
            <div id="updateResponse"></div>
        </div>

        <!-- Delete Time Entry -->
        <div class="container">
            <h2>üóëÔ∏è Delete Time Entry (Draft Only)</h2>
            <div class="form-group">
                <label for="deleteTimeEntryId">Time Entry ID:</label>
                <input type="number" id="deleteTimeEntryId" required>
            </div>
            <button class="danger" onclick="deleteTimeEntry()">Delete Entry</button>
            <div id="deleteResponse"></div>
        </div>
    </div>

    <!-- Bulk Operations -->
    <div class="container">
        <h2>üì¶ Bulk Time Entries Operations</h2>
        <div class="form-group">
            <label for="bulkWeekStart">Week Start (Monday):</label>
            <input type="date" id="bulkWeekStart" required>
        </div>
        <div class="form-group">
            <label>Bulk Entries (JSON format):</label>
            <textarea id="bulkTimeEntries" rows="12" placeholder='[
  {
    "date": "2025-08-04",
    "start_time": "09:00",
    "end_time": "17:00",
    "break_duration": 60,
    "description": "Regular work day",
    "location": "Office"
  },
  {
    "date": "2025-08-05",
    "start_time": "09:00",
    "end_time": "18:00",
    "break_duration": 60,
    "description": "Extended work day",
    "is_overtime": true,
    "overtime_reason": "Project deadline"
  }
]'></textarea>
        </div>
        <button class="warning" onclick="bulkTimeEntriesOperation()">Execute Bulk Operation</button>
        <div id="bulkTimeResponse"></div>
    </div>

    <div class="grid">
        <!-- Submit Weekly Time Entries -->
        <div class="container">
            <h2>üì§ Submit Weekly Time Entries</h2>
            <div class="form-group">
                <label for="submitEmployeeId">Employee ID (optional for own):</label>
                <input type="number" id="submitEmployeeId" placeholder="Leave empty for self">
            </div>
            <div class="form-group">
                <label for="submitWeekStart">Week Start Date:</label>
                <input type="date" id="submitWeekStart" required>
            </div>
            <button class="success" onclick="submitWeeklyTimeEntries()">Submit for Validation</button>
            <div id="submitResponse"></div>
        </div>

        <!-- Time Comparison -->
        <div class="container">
            <h2>üìä Compare Planning vs Actual</h2>
            <div class="form-group">
                <label for="compareEmployeeId">Employee ID:</label>
                <input type="number" id="compareEmployeeId" value="1" required>
            </div>
            <div class="form-group">
                <label for="compareDateFrom">Date From (optional):</label>
                <input type="date" id="compareDateFrom">
            </div>
            <div class="form-group">
                <label for="compareDateTo">Date To (optional):</label>
                <input type="date" id="compareDateTo">
            </div>
            <button onclick="compareTimeWithPlanning()">Compare Time vs Planning</button>
            <div id="compareResponse"></div>
        </div>
    </div>

    <script>
        function getAuthToken() {
            return document.getElementById('authToken').value.trim();
        }

        function showResponse(elementId, data, isError = false) {
            const element = document.getElementById(elementId);
            const className = isError ? 'error' : 'success';
            element.innerHTML = `
                <div class="${className}">
                    ${isError ? 'Error' : 'Success'}
                </div>
                <div class="response">${JSON.stringify(data, null, 2)}</div>
            `;
        }

        async function makeRequest(url, method = 'GET', body = null) {
            const token = getAuthToken();
            if (!token) {
                throw new Error('Please provide an access token');
            }

            const options = {
                method,
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${token}`,
                },
            };

            if (body) {
                options.body = JSON.stringify(body);
            }

            try {
                const response = await fetch(url, options);
                const data = await response.json();
                
                if (!response.ok) {
                    throw { status: response.status, data };
                }
                
                return data;
            } catch (error) {
                throw error;
            }
        }

        // Auth Test
        async function testAuthUser() {
            try {
                const result = await makeRequest('/api/auth/me');
                showResponse('authResponse', result);
            } catch (error) {
                showResponse('authResponse', error, true);
            }
        }

        // Get Time Entries
        async function getTimeEntries() {
            try {
                const params = new URLSearchParams();
                
                const dateFrom = document.getElementById('timeEntryDateFrom').value;
                if (dateFrom) params.append('date_from', dateFrom);
                
                const dateTo = document.getElementById('timeEntryDateTo').value;
                if (dateTo) params.append('date_to', dateTo);
                
                const employeeId = document.getElementById('timeEntryEmployeeId').value;
                if (employeeId) params.append('employee_id', employeeId);
                
                const status = document.getElementById('timeEntryStatus').value;
                if (status) params.append('status', status);
                
                const groupBy = document.getElementById('timeEntryGroupBy').value;
                params.append('group_by', groupBy);

                const result = await makeRequest(`/api/time-entries?${params.toString()}`);
                showResponse('timeEntriesResponse', result);
            } catch (error) {
                showResponse('timeEntriesResponse', error, true);
            }
        }

        // Get Current Day Time Entries
        async function getCurrentDayTimeEntries() {
            try {
                const employeeId = document.getElementById('currentEmployeeId').value;
                
                if (!employeeId) {
                    throw new Error('Employee ID is required');
                }

                const result = await makeRequest(`/api/time-entries/${employeeId}/current`);
                showResponse('currentDayResponse', result);
            } catch (error) {
                showResponse('currentDayResponse', error, true);
            }
        }

        // Create Time Entry
        async function createTimeEntry() {
            try {
                const timeEntryData = {
                    date: document.getElementById('createDate').value,
                    start_time: document.getElementById('createStartTime').value,
                    end_time: document.getElementById('createEndTime').value,
                    break_duration: parseInt(document.getElementById('createBreakDuration').value) || 0,
                    description: document.getElementById('createDescription').value,
                    location: document.getElementById('createLocation').value,
                    is_overtime: document.getElementById('createIsOvertime').checked,
                };

                if (!timeEntryData.date || !timeEntryData.start_time || !timeEntryData.end_time) {
                    throw new Error('Date, start time, and end time are required');
                }

                const projectId = document.getElementById('createProjectId').value;
                if (projectId) timeEntryData.project_id = parseInt(projectId);

                const taskId = document.getElementById('createTaskId').value;
                if (taskId) timeEntryData.task_id = parseInt(taskId);

                const overtimeReason = document.getElementById('createOvertimeReason').value;
                if (overtimeReason) timeEntryData.overtime_reason = overtimeReason;

                const result = await makeRequest('/api/time-entries', 'POST', timeEntryData);
                showResponse('createResponse', result);
            } catch (error) {
                showResponse('createResponse', error, true);
            }
        }

        // Update Time Entry
        async function updateTimeEntry() {
            try {
                const entryId = document.getElementById('updateTimeEntryId').value;
                if (!entryId) {
                    throw new Error('Time entry ID is required');
                }

                const updateData = {};
                
                const date = document.getElementById('updateDate').value;
                if (date) updateData.date = date;
                
                const startTime = document.getElementById('updateStartTime').value;
                if (startTime) updateData.start_time = startTime;
                
                const endTime = document.getElementById('updateEndTime').value;
                if (endTime) updateData.end_time = endTime;
                
                const breakDuration = document.getElementById('updateBreakDuration').value;
                if (breakDuration) updateData.break_duration = parseInt(breakDuration);
                
                const description = document.getElementById('updateDescription').value;
                if (description) updateData.description = description;
                
                if (document.getElementById('updateIsOvertime').checked) {
                    updateData.is_overtime = true;
                }

                if (Object.keys(updateData).length === 0) {
                    throw new Error('Please provide at least one field to update');
                }

                const result = await makeRequest(`/api/time-entries/${entryId}`, 'PUT', updateData);
                showResponse('updateResponse', result);
            } catch (error) {
                showResponse('updateResponse', error, true);
            }
        }

        // Delete Time Entry
        async function deleteTimeEntry() {
            try {
                const entryId = document.getElementById('deleteTimeEntryId').value;
                if (!entryId) {
                    throw new Error('Time entry ID is required');
                }

                if (!confirm('Are you sure you want to delete this time entry?')) {
                    return;
                }

                const result = await makeRequest(`/api/time-entries/${entryId}`, 'DELETE');
                showResponse('deleteResponse', result);
            } catch (error) {
                showResponse('deleteResponse', error, true);
            }
        }

        // Bulk Time Entries Operation
        async function bulkTimeEntriesOperation() {
            try {
                const weekStart = document.getElementById('bulkWeekStart').value;
                const entriesText = document.getElementById('bulkTimeEntries').value;
                
                if (!weekStart) {
                    throw new Error('Week start date is required');
                }
                
                if (!entriesText) {
                    throw new Error('Please provide entries in JSON format');
                }

                let entries;
                try {
                    entries = JSON.parse(entriesText);
                } catch (e) {
                    throw new Error('Invalid JSON format');
                }

                if (!Array.isArray(entries) || entries.length === 0) {
                    throw new Error('Entries must be a non-empty array');
                }

                const result = await makeRequest('/api/time-entries/bulk', 'POST', {
                    entries,
                    week_start: weekStart
                });
                showResponse('bulkTimeResponse', result);
            } catch (error) {
                showResponse('bulkTimeResponse', error, true);
            }
        }

        // Submit Weekly Time Entries
        async function submitWeeklyTimeEntries() {
            try {
                const submitData = {
                    week_start_date: document.getElementById('submitWeekStart').value,
                };

                if (!submitData.week_start_date) {
                    throw new Error('Week start date is required');
                }

                const employeeId = document.getElementById('submitEmployeeId').value;
                if (employeeId) submitData.employee_id = parseInt(employeeId);

                const result = await makeRequest('/api/time-entries/submit', 'POST', submitData);
                showResponse('submitResponse', result);
            } catch (error) {
                showResponse('submitResponse', error, true);
            }
        }

        // Compare Time with Planning
        async function compareTimeWithPlanning() {
            try {
                const employeeId = document.getElementById('compareEmployeeId').value;
                if (!employeeId) {
                    throw new Error('Employee ID is required');
                }

                const params = new URLSearchParams();
                
                const dateFrom = document.getElementById('compareDateFrom').value;
                if (dateFrom) params.append('date_from', dateFrom);
                
                const dateTo = document.getElementById('compareDateTo').value;
                if (dateTo) params.append('date_to', dateTo);

                const result = await makeRequest(`/api/time-entries/compare/${employeeId}?${params.toString()}`);
                showResponse('compareResponse', result);
            } catch (error) {
                showResponse('compareResponse', error, true);
            }
        }

        // Pre-fill some demo data
        const today = new Date();
        const yesterday = new Date(today);
        yesterday.setDate(today.getDate() - 1);
        const nextWeek = new Date(today);
        nextWeek.setDate(today.getDate() + 7);
        
        // Set default dates
        document.getElementById('timeEntryDateFrom').value = yesterday.toISOString().split('T')[0];
        document.getElementById('timeEntryDateTo').value = today.toISOString().split('T')[0];
        document.getElementById('createDate').value = today.toISOString().split('T')[0];
        
        // Set Monday as week start
        const monday = new Date(today);
        monday.setDate(today.getDate() - today.getDay() + 1);
        document.getElementById('bulkWeekStart').value = monday.toISOString().split('T')[0];
        document.getElementById('submitWeekStart').value = monday.toISOString().split('T')[0];
        
        // Set default times
        document.getElementById('createStartTime').value = '09:00';
        document.getElementById('createEndTime').value = '17:00';
        
        // Demo employee IDs
        document.getElementById('timeEntryEmployeeId').value = '1';
        document.getElementById('currentEmployeeId').value = '1';
        document.getElementById('compareEmployeeId').value = '1';
    </script>
</body>
</html>